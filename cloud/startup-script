# update
apt-get update && sudo apt-get -y upgrade

# install git
apt-get install -y git

# install nodejs
curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
apt-get install -y nodejs

# set up GITHUB DEPLOY SSH KEY
mkdir -p ~/.ssh
chmod 700 ~/.ssh
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/GITHUB_DEPLOY_PRIVATE_KEY" -H "Metadata-Flavor: Google" >~/.ssh/id_rsa
chmod 600 ~/.ssh/id_rsa
ssh-keyscan -H github.com >~/.ssh/known_hosts

# set up GOOGLE_APPLICATION_CREDENTIALS
curl "http://metadata.google.internal/computeMetadata/v1/project/attributes/GOOGLE_APPLICATION_CREDENTIALS_DATA" -H "Metadata-Flavor: Google" >~/.GOOGLE_APPLICATION_CREDENTIALS_FILE

# clone repo
rm -rf website-mockup
git clone git@github.com:4by34/website-mockup.git

# start webhook
cd website-mockup
npm install
TRIGGER_KEY= GOOGLE_APPLICATION_CREDENTIALS=~/.GOOGLE_APPLICATION_CREDENTIALS_FILE node cloud/webhook.js
